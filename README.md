# `coqffi`

**`coqffi` automatically generates Coq FFI bindings to OCaml
libraries.**

For example, given the OCaml header file `file.mli`:

```ocaml
open Coqbase

type fd

val openfile : Bytestring.t -> fd
val read_all : fd -> Bytestring.t
val write : fd -> Bytestring.t -> unit
val closefile : fd -> unit

val fd_equal : fd -> fd -> bool
  [@@ffi_pure]

val swap : ('a -> 'b -> 'c) -> 'b -> 'a -> 'c
  [@@ffi_pure] [@@coq_model "fun _ _ _ f x y => f y x"]
```

`coqffi` generates the necessary Coq boilerplate to use these
functions in a Coq development, and to configure the extraction
mechanism accordingly.

*Note:* Currently, `coqffi` relies on
[FreeSpec](https://github.com/ANSSI-FR/FreeSpec) to model OCaml impure
functions. We expect to support more frameworks in the future, such as
[Interactive Trees](https://github.com/DeepSpec/InteractionTrees)

```coq
(* This file has been generated by coqffi. *)

Set Implicit Arguments.

From FreeSpec.Core Require Import All.

(** * Types *)

Axiom (fd : Type).

(** * Pure Functions *)

Axiom (fd_equal : fd -> fd -> bool).

Definition swap
  : forall (a : Type) (b : Type) (c : Type), (a -> b -> c) -> b -> a -> c :=
  fun _ _ _ f x y => f y x.

(** * Impure Primitives *)

(** ** Interface Definition *)

Inductive FILE : interface :=
| Openfile : Base.Data.Bytestring.bytestring -> FILE fd
| Read_all : fd -> FILE Base.Data.Bytestring.bytestring
| Write : fd -> Base.Data.Bytestring.bytestring -> FILE unit
| Closefile : fd -> FILE unit.

(** ** Primitive Helpers *)

Definition openfile `{Provide ix FILE} (x0 : Base.Data.Bytestring.bytestring)
  : impure ix fd :=
  request (Openfile x0).

Definition read_all `{Provide ix FILE} (x0 : fd)
  : impure ix Base.Data.Bytestring.bytestring :=
  request (Read_all x0).

Definition write `{Provide ix FILE} (x0 : fd)
(x1 : Base.Data.Bytestring.bytestring) : impure ix unit :=
  request (Write x0 x1).

Definition closefile `{Provide ix FILE} (x0 : fd) : impure ix unit :=
  request (Closefile x0).

(** * Extraction *)

Module FileExtr.
  (** ** Extractable Semantics *)

  Axiom (ocaml_openfile : Base.Data.Bytestring.bytestring -> fd).
  Axiom (ocaml_read_all : fd -> Base.Data.Bytestring.bytestring).
  Axiom (ocaml_write : fd -> Base.Data.Bytestring.bytestring -> unit).
  Axiom (ocaml_closefile : fd -> unit).

  Definition file : semantics FILE :=
    bootstrap (fun a e =>
      local match e in FILE a return a with
            | Openfile x0 => ocaml_openfile x0
            | Read_all x0 => ocaml_read_all x0
            | Write x0 x1 => ocaml_write x0 x1
            | Closefile x0 => ocaml_closefile x0
            end).

  (** ** Extraction Configuration *)

  Extract Constant fd => "Demo.File.fd".
  Extract Constant fd_equal => "Demo.File.fd_equal".
  Extract Constant swap => "Demo.File.swap".
  Extract Constant ocaml_openfile => "Demo.File.openfile".
  Extract Constant ocaml_read_all => "Demo.File.read_all".
  Extract Constant ocaml_write => "Demo.File.write".
  Extract Constant ocaml_closefile => "Demo.File.closefile".
End FileExtr.
```
